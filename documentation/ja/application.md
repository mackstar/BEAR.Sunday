---
layout: default_ja
title: BEAR.Sunday | アプリケーション
category: アプリケーション
---
# アプリケーション
## 導入 

bootstrapで生成されるアプリケーションオブジェクトはアプリケーションの実行が記述してあるアプリケーションスクリプトに必要な全てのサービスオブジェクトを含んでいます。利用する全てのオブジェクトはこのオブジェクトに含まれるか、含まれたファクトリーで生成されます。

オブジェクトを生成するためにはまずその依存が必要です。しかしその依存もまた依存が必要で、そのまた..と続き最終的にアプリケーションオブジェクトがオブジェクトグラフ（オブジェクト間の関係性）として取得されます。

## コンパイルとランタイム　

[module モジュール]はオブジェクトの抽象（インターフェイスや抽象クラス）と実装（実クラスやファクトリー）の束縛、それにメソッドとその横断的振る舞い（アスペクト）の束縛の集合です。アプリケーションはモードによってそのモジュールが選択され、その構成知識でアプリケーションオブジェクトが生成されます。

BEAR.Sundayは「依存性の注入パターン」に基づいていて、アプリケーションオブジェクトはそのコンストラクション（コンパイルタイム）と実行（ランタイム）にはっきりとした区別があります。オブジェクトはconstructionを行うオブジェクトと、executionを行うオブジェクトにはっきりと区別され混ざりません。

 * boot時にモードに応じたアプリケーションオブジェクトが生成されます。（コンパイルタイム）
 * その後はオブジェクトのexecution（実行）が始まります（ランタイム）
 * executionの時に新しいオブジェクトを都度取得するときには`Provider`を使います。それ以外の方法ではオブジェクトの取得を原則行いません。

## コンストラクションの再利用 

オブジェクトの組み立ては一度しか行われません。オブジェクトは実行モードに応じたモジュールに基づいて依存が注入されアスペクトが特定メソッドに織り込ます。これが依存の依存も…という風に繰り返され最終的なオブジェクトグラフになります。出来上がったオブジェクトグラフはAPCのオブジェクトコンテナに格納されリクエストをまたいで再利用されます。

つまりBEAR.Sundayアプリケーションではコンストラクタはサービスを開始してオブジェクトの最初の実行時のコンパイルの一度だけしか実行されません。二度目からはコンストラクションが行われずコンテナから取り出し再利用されるからです。

## 早期束縛 

アプリケーションのランタイムに依存せず、リクエスト毎に変わらない依存の注入はこのコンパイルで完了しておくようにします。

モジュールを使ったコンフィギュレーションはオブジェクトがどのように構成されるかを決めるものであって、オブジェクトのランタイムでの実行を直接決めるものではありません。

例えばランタイムでコンフィギュレーションを見て振る舞いを変更する事は推奨されません。

    // 非推奨
    if ($config['debug'] # = true) {
        // debug用の振る舞い
    }


その代わりに *コンパイル時にコンフィギュレーションを見て振る舞いの違うオブジェクトを束縛* します。コンパイルが完了したオブジェクトは、ランタイムでの可変点のみの処理を行うようにします。つまり毎リクエスト同じ文字列をアサインするようなコードは非推奨です。

例えば開発画面で様々なオブジェクトの情報が確認できるツールが現れるのは、レンダラインターフェイスに開発用レンダラが束縛されているためで、レンダラがモードを確認してレンダリングを変えているのでありません。つまりアプリケーションの`mode`は実行時の振る舞いをランタイムで変えるための変数ではなくて、そのモードに応じたオブジェクトを生成するためのものです。`Sandbox`アプリケーションを構成するそれぞれのオブジェクトは実行モードを知りません。

## 遅延束縛 

依存にはリクエストを通じて変わらないものと、ランタイムの時にしか決定できないものがあります。例えばログオブジェクトはどのリクエストでも必要かもしれませんが、DBオブジェクトはリクエストメソッドに応じたインスタンスが必要で（master/slave)、コンパイル時に早期束縛する事はできません。

メソッドに対して割込むインターセプターが依存を遅延束縛することでその問題を解決します。インターセプターはメソッドが実行される直前にコンテキストに応じて依存を注入する事ができます。

早期束縛と遅延束縛の明確な区別はソフトウエアの品質とパフォーマンスの向上を目的としていて、BEAR.Sundayの特徴になってます。