<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>BEAR.Sunday | Aspect Orientated Programming</title>

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="http://localhost:4000//css/bootstrap.min.css">
        <link rel="stylesheet" href="http://localhost:4000//css/main.css">

    </head>
    <body>
    <div id="wrap">
      <div class="container">
        <a href="http://localhost:4000/">
            <img src="http://localhost:4000//img/logo.png" />
        </a>


        </div>



<p></p>
<div class="container">

<div class="row">
  <div class="col-md-12">
    <ul class="nav nav-tabs">
      <li><a href="install.html">Start Here!</a></li>

      <li><a href="rest.html">REST - Hypermedia</a></li>
      <li><a href="di.html">Dependency Injection</a></li>
      <li class="active"><a href="aop.html">Aspect Orientated Programming</a></li>


      <li><a href="my_first_resource.html">My First - Tutorial</a></li>
      <li><a href="blog_install.html">Blog Tutorial</a></li>
      <li><a href="faq.html">Other Stuff</a></li>
    </ul>
  </div>
</div>
<p></p>

<div class="row">
  <div class="col-md-3">

    <div class="panel panel-default">
	<div class="panel-heading"><strong>Getting Started</strong></div>
	<div class="panel-body">

	<ul class="nav nav-pills nav-stacked">
		



		
   			
<li><a href="install.html">Installation</a></li>
<li><a href="rest.html">REST - Hypermedia</a></li>
<li><a href="di.html">Dependency Injection</a></li>
<li><a href="aop.html">Aspect Orientated Programming</a></li>

		

		

		

		

		

		

		
	</ul>
</div>
</div>


  </div>
  <div class="col-md-9">

     <h1 id="toc_0">Aspect Oriented Framework for PHP</h1>

<p><a href="https://packagist.org/packages/ray/aop"><img src="https://poser.pugx.org/ray/aop/v/stable.png" alt="Latest Stable Version"></a>
<a href="http://travis-ci.org/koriym/Ray.Aop"><img src="https://secure.travis-ci.org/koriym/Ray.Aop.png" alt="Build Status"></a></p>

<p><strong>Ray.Aop</strong> package provides method interception. This feature enables you to write code that is executed each time a matching method is invoked. It&#39;s suited for cross cutting concerns (&quot;aspects&quot;), such as transactions, security and logging. Because interceptors divide a problem into aspects rather than objects, their use is called Aspect Oriented Programming (AOP).</p>

<p>A <a href="http://koriym.github.io/Ray.Aop/api/interfaces/Ray_Aop_Matchable.html">Matcher</a> is a simple interface that either accepts or rejects a value. For Ray.AOP, you need two matchers: one that defines which classes participate, and another for the methods of those classes. To make this easy, there&#39;s factory class to satisfy the common scenarios.</p>

<p><a href="http://koriym.github.io/Ray.Aop/api/interfaces/Ray_Aop_MethodInterceptor.html">MethodInterceptors</a> are executed whenever a matching method is invoked. They have the opportunity to inspect the call: the method, its arguments, and the receiving instance. They can perform their cross-cutting logic and then delegate to the underlying method. Finally, they may inspect the return value or exception and return. Since interceptors may be applied to many methods and will receive many calls, their implementation should be efficient and unintrusive.</p>

<h2 id="toc_1">Example: Forbidding method calls on weekends</h2>

<p>To illustrate how method interceptors work with Ray.Aop, we&#39;ll forbid calls to our pizza billing system on weekends. The delivery guys only work Monday thru Friday so we&#39;ll prevent pizza from being ordered when it can&#39;t be delivered! This example is structurally similar to use of AOP for authorization.</p>

<p>To mark select methods as weekdays-only, we define an annotation.
(Ray.Aop uses Doctrine Annotations)</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * NotOnWeekends</span>
<span class="sd"> *</span>
<span class="sd"> * @Annotation</span>
<span class="sd"> * @Target(&quot;METHOD&quot;)</span>
<span class="sd"> */</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">NotOnWeekends</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></div>
<p>...and apply it to the methods that need to be intercepted:</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">RealBillingService</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @NotOnWeekends</span>
<span class="sd">     */</span>
    <span class="nx">chargeOrder</span><span class="p">(</span><span class="nx">PizzaOrder</span> <span class="nv">$order</span><span class="p">,</span> <span class="nx">CreditCard</span> <span class="nv">$creditCard</span><span class="p">)</span>
    <span class="p">{</span>
</code></pre></div>
<p>Next, we define the interceptor by implementing the org.aopalliance.intercept.MethodInterceptor interface. When we need to call through to the underlying method, we do so by calling $invocation-&gt;proceed():</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">WeekendBlocker</span> <span class="k">implements</span> <span class="nx">MethodInterceptor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">invoke</span><span class="p">(</span><span class="nx">MethodInvocation</span> <span class="nv">$invocation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$today</span> <span class="o">=</span> <span class="nb">getdate</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$today</span><span class="p">[</span><span class="s1">&#39;weekday&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;S&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\RuntimeException</span><span class="p">(</span>
                <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="na">getMethod</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot; not allowed on weekends!&quot;</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="na">proceed</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Finally, we configure everything. In this case we match any class, but only the methods with our @NotOnWeekends annotation:</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$bind</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bind</span><span class="p">;</span>
<span class="nv">$matcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Matcher</span><span class="p">(</span><span class="k">new</span> <span class="nx">Reader</span><span class="p">);</span>
<span class="nv">$interceptors</span> <span class="o">=</span> <span class="p">[</span><span class="k">new</span> <span class="nx">WeekendBlocker</span><span class="p">];</span>
<span class="nv">$pointcut</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pointcut</span><span class="p">(</span>
        <span class="nv">$matcher</span><span class="o">-&gt;</span><span class="na">any</span><span class="p">(),</span>
        <span class="nv">$matcher</span><span class="o">-&gt;</span><span class="na">annotatedWith</span><span class="p">(</span><span class="s1">&#39;Ray\Aop\Sample\Annotation\NotOnWeekends&#39;</span><span class="p">),</span>
        <span class="nv">$interceptors</span>
<span class="p">);</span>
<span class="nv">$bind</span><span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="s1">&#39;Ray\Aop\Sample\AnnotationRealBillingService&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nv">$pointcut</span><span class="p">]);</span>

<span class="nv">$compiler</span> <span class="o">=</span> <span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="nx">__DIR__</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;/scripts/instance.php&#39;</span><span class="p">;</span>
<span class="nv">$billing</span> <span class="o">=</span> <span class="nv">$compiler</span><span class="o">-&gt;</span><span class="na">newInstance</span><span class="p">(</span><span class="s1">&#39;RealBillingService&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nv">$bind</span><span class="p">);</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$billing</span><span class="o">-&gt;</span><span class="na">chargeOrder</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\RuntimeException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Putting it all together, (and waiting until Saturday), we see the method is intercepted and our order is rejected:</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nx">RuntimeException</span><span class="o">:</span> <span class="nx">chargeOrder</span> <span class="k">not</span> <span class="nx">allowed</span> <span class="nx">on</span> <span class="nx">weekends</span><span class="o">!</span> <span class="nx">in</span> <span class="o">/</span><span class="nx">apps</span><span class="o">/</span><span class="nx">pizza</span><span class="o">/</span><span class="nx">WeekendBlocker</span><span class="o">.</span><span class="nx">php</span> <span class="nx">on</span> <span class="nx">line</span> <span class="mi">14</span>

<span class="nx">Call</span> <span class="nx">Stack</span><span class="o">:</span>
    <span class="mf">0.0022</span>     <span class="mi">228296</span>   <span class="mf">1.</span> <span class="p">{</span><span class="nx">main</span><span class="p">}()</span> <span class="o">/</span><span class="nx">apps</span><span class="o">/</span><span class="nx">pizza</span><span class="o">/</span><span class="nx">main</span><span class="o">.</span><span class="nx">php</span><span class="o">:</span><span class="mi">0</span>
    <span class="mf">0.0054</span>     <span class="mi">317424</span>   <span class="mf">2.</span> <span class="nx">Ray\Aop\Weaver</span><span class="o">-&gt;</span><span class="na">chargeOrder</span><span class="p">()</span> <span class="o">/</span><span class="nx">apps</span><span class="o">/</span><span class="nx">pizza</span><span class="o">/</span><span class="nx">main</span><span class="o">.</span><span class="nx">php</span><span class="o">:</span><span class="mi">14</span>
    <span class="mf">0.0054</span>     <span class="mi">317608</span>   <span class="mf">3.</span> <span class="nx">Ray\Aop\Weaver</span><span class="o">-&gt;</span><span class="na">__call</span><span class="p">()</span> <span class="o">/</span><span class="nx">libs</span><span class="o">/</span><span class="nx">Ray</span><span class="o">.</span><span class="nx">Aop</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">Weaver</span><span class="o">.</span><span class="nx">php</span><span class="o">:</span><span class="mi">14</span>
    <span class="mf">0.0055</span>     <span class="mi">318384</span>   <span class="mf">4.</span> <span class="nx">Ray\Aop\ReflectiveMethodInvocation</span><span class="o">-&gt;</span><span class="na">proceed</span><span class="p">()</span> <span class="o">/</span><span class="nx">libs</span><span class="o">/</span><span class="nx">Ray</span><span class="o">.</span><span class="nx">Aop</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">Weaver</span><span class="o">.</span><span class="nx">php</span><span class="o">:</span><span class="mi">68</span>
    <span class="mf">0.0056</span>     <span class="mi">318784</span>   <span class="mf">5.</span> <span class="nx">Ray\Aop\Sample\WeekendBlocker</span><span class="o">-&gt;</span><span class="na">invoke</span><span class="p">()</span> <span class="o">/</span><span class="nx">libs</span><span class="o">/</span><span class="nx">Ray</span><span class="o">.</span><span class="nx">Aop</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">ReflectiveMethodInvocation</span><span class="o">.</span><span class="nx">php</span><span class="o">:</span><span class="mi">65</span>
</code></pre></div>
<h2 id="toc_2">Explicit method name match</h2>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
    <span class="nv">$bind</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bind</span><span class="p">;</span>
    <span class="nv">$bind</span><span class="o">-&gt;</span><span class="na">bindInterceptors</span><span class="p">(</span><span class="s1">&#39;chargeOrder&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">new</span> <span class="nx">WeekendBlocker</span><span class="p">]);</span>

    <span class="nv">$compiler</span> <span class="o">=</span> <span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="nx">__DIR__</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;/scripts/instance.php&#39;</span><span class="p">;</span>
    <span class="nv">$billing</span> <span class="o">=</span> <span class="nv">$compiler</span><span class="o">-&gt;</span><span class="na">newInstance</span><span class="p">(</span><span class="s1">&#39;RealBillingService&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nv">$bind</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
       <span class="k">echo</span> <span class="nv">$billing</span><span class="o">-&gt;</span><span class="na">chargeOrder</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\RuntimeException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
       <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<h2 id="toc_3">Limitations</h2>

<p>Behind the scenes, method interception is implemented by generating code at runtime. Ray.Aop dynamically creates a subclass that applies interceptors by overriding methods.</p>

<p>This approach imposes limits on what classes and methods can be intercepted:</p>

<ul>
<li>Classes must be <em>non-final</em></li>
<li>Methods must be <em>public</em></li>
<li>Methods must be <em>non-final</em></li>
</ul>

<h2 id="toc_4">AOP Alliance</h2>

<p>The method interceptor API implemented by Ray.Aop is a part of a public specification called <a href="http://aopalliance.sourceforge.net/doc/org/aopalliance/intercept/MethodInterceptor.html">AOP Alliance</a>. </p>

<h1 id="toc_5">Testing Ray.Aop Stand-Alone</h1>

<p>Here&#39;s how to install Ray.Aop from source to run the unit tests and sample:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ git clone git://github.com/koriym/Ray.Aop.git
$ cd Ray.Aop
$ wget http://getcomposer.org/composer.phar
$ php composer.phar install
$ php doc/sample-01-quick-weave/main.php
// Charged. | chargeOrder not allowed on weekends!
</code></pre></div>
<h2 id="toc_6">Requirements</h2>

<ul>
<li>PHP 5.4+</li>
</ul>

<h3 id="toc_7">ini_set</h3>

<p>You may want to set the <code>xdebug.max_nesting_level</code> ini option to a higher value:</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="x">ini_set(&#39;xdebug.max_nesting_level&#39;, 2000);</span>
</code></pre></div>
<ul>
<li>This documentation for the most part is taken from <a href="https://code.google.com/p/google-guice/wiki/AOP">Guice/AOP</a>.</li>
</ul>

  </div>
</div>

</div>
 

			</div>
    	</div>
    	<div id="footer">
      		<div class="container">
        		<p class="text-muted credit">

        			Checkout BEAR.Sunday on <a href="https://github.com/koriym/BEAR.Sunday">Github</a>.

        		</p>
      		</div>
    	</div>
      <script type="text/javascript" src="http://localhost:4000//js/jquery.js"></script>
      <script type="text/javascript">
        $('table').addClass('table');
      </script>
    </body>
</html>